define(["jquery.ui","clockpicker"],function(a,b){var c={};return c.init=function(a){window.tmodtpl=a.tmodtpl,c.attachurl=a.attachurl,c.id=a.id,c.data=a.data,c.data||(c.data={name:"套餐红包",rules:"",params:{title:"抢价值30元红包套餐",placeholder:"内含5元红包 x 6个",backgroundImage:"../addons/we7_wmall/plugin/mealRedpacket/static/img/meal_title_bg.png",price:15,btnText:"立即抢购",tips:{T0123456789101:{imgurl:"../addons/we7_wmall/plugin/mealRedpacket/static/img/meal_day.png",text:"有效期31天",color:"#999999"},T0123456789102:{imgurl:"../addons/we7_wmall/plugin/mealRedpacket/static/img/meal_circle.png",text:"每月限购1次",color:"#999999"},T0123456789103:{imgurl:"../addons/we7_wmall/plugin/mealRedpacket/static/img/meal_percent.png",text:"与优惠活动同享",color:"#999999"}},exchangeStatus:1},style:{rulesColor:"#ffffff",titleColor:"#ffffff",placeholderColor:"#ffffff",btnColor:"#ffdee3",btnBackground:"#b64d57"},redpackets:{M0123456789101:{scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}},M0123456789102:{scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}},M0123456789103:{scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}},M0123456789104:{scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}},M0123456789105:{scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}},M0123456789106:{scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}}},exchanges:{S0123456789101:{store_id:0,logo:"../addons/we7_wmall/plugin/mealRedpacket/static/img/store-1.jpg",title:"门店名称",score:"5",activity:"满35减12;满60减20",discount:10,condition:0,grant_days_effect:0,use_days_limit:31},S0123456789102:{store_id:0,logo:"../addons/we7_wmall/plugin/mealRedpacket/static/img/store-2.jpg",title:"门店名称",score:"5",activity:"满35减12;满60减20",discount:10,condition:0,grant_days_effect:0,use_days_limit:31},S0123456789103:{store_id:0,logo:"../addons/we7_wmall/plugin/mealRedpacket/static/img/store-3.jpg",title:"门店名称",score:"5",activity:"满35减12;满60减20",discount:10,condition:0,grant_days_effect:0,use_days_limit:31}}}),tmodtpl.helper("tomedia",function(a){return"string"!=typeof a?"":0==a.indexOf("http://")||0==a.indexOf("https://")||0==a.indexOf("../addons")?a:0==a.indexOf("images/")?c.attachurl+a:void 0}),c.tplmealRedpacket(),c.tplEditor(),c.initGotop(),c.save()},jQuery.base64=function(a){function b(a,b){var c=h.indexOf(a.charAt(b));if(-1===c)throw"Cannot decode base64";return c}function c(a,b){for(;a.length>0;){var c=a[0];if(c<128)a.shift(),b.push(String.fromCharCode(c));else if(192==(128&c)){if(a.length<2)break;c=a.shift();var d=a.shift();b.push(String.fromCharCode(((31&c)<<6)+(63&d)))}else{if(a.length<3)break;c=a.shift();var d=a.shift(),e=a.shift();b.push(String.fromCharCode(((15&c)<<12)+((63&d)<<6)+(63&e)))}}}function d(a){var d,e,f=0,h=a.length,i=[],j=[];if(a=String(a),0===h)return a;if(h%4!=0)throw"Cannot decode base64";for(a.charAt(h-1)===g&&(f=1,a.charAt(h-2)===g&&(f=2),h-=4),d=0;d<h;d+=4){b(a,d),b(a,d+1),b(a,d+2),b(a,d+3);e=b(a,d)<<18|b(a,d+1)<<12|b(a,d+2)<<6|b(a,d+3),j.push(e>>16),j.push(e>>8&255),j.push(255&e),c(j,i)}switch(f){case 1:e=b(a,d)<<18|b(a,d+1)<<12|b(a,d+2)<<6,j.push(e>>16),j.push(e>>8&255);break;case 2:e=b(a,d)<<18|b(a,d+1)<<12,j.push(e>>16)}if(c(j,i),j.length>0)throw"Cannot decode base64";return i.join("")}function e(a,b){a<128?b.push(a):a<2048?(b.push(192+(a>>6&31)),b.push(128+(63&a))):(b.push(224+(a>>12&15)),b.push(128+(a>>6&63)),b.push(128+(63&a)))}function f(a){if(1!==arguments.length)throw"SyntaxError: exactly one argument required";if(a=String(a),0===a.length)return a;var b,c,d=[],f=[],i=a.length;for(b=0;b<i;){for(e(a.charCodeAt(b),d);d.length>=3;){var j=d.shift(),k=d.shift();c=j<<16|k<<8|d.shift(),f.push(h.charAt(c>>18)),f.push(h.charAt(c>>12&63)),f.push(h.charAt(c>>6&63)),f.push(h.charAt(63&c))}b++}switch(d.length){case 1:c=d.shift()<<16,f.push(h.charAt(c>>18)+h.charAt(c>>12&63)+g+g);break;case 2:var j=d.shift(),k=d.shift();c=j<<16|k<<8,f.push(h.charAt(c>>18)+h.charAt(c>>12&63)+h.charAt(c>>6&63)+g)}return f.join("")}var g="=",h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";return{decode:d,encode:f,VERSION:"1.1"}}(jQuery),c.tplmealRedpacket=function(){var a=tmodtpl("tpl-show-mealRedpacket",c.data);b("#app-preview").html(a)},c.tplEditor=function(){var a=tmodtpl("tpl-edit-mealRedpacket",c.data);if(b("#app-editor .inner").html(a),b(".clockpicker :text").clockpicker({autoclose:!0}),b("#app-editor .form-richtext").length>0){var d={autoClearinitialContent:!1,toolbars:[["fullscreen","source","preview","|","bold","italic","underline","strikethrough","forecolor","backcolor","|","justifyleft","justifycenter","justifyright","|","insertorderedlist","insertunorderedlist","blockquote","emotion","removeformat","|","rowspacingtop","rowspacingbottom","lineheight","indent","paragraph","fontsize","|","inserttable","deletetable","insertparagraphbeforetable","insertrow","deleterow","insertcol","deletecol","mergecells","mergeright","mergedown","splittocells","splittorows","splittocols","|","anchor","map","print","drafts","|","link"]],elementPathEnabled:!1,initialFrameHeight:300,focus:!1,maximumWords:9999999999999},e={type:"image",direct:!1,multiple:!0,tabs:{upload:"active",browser:"",crawler:""},path:"",dest_dir:"",global:!1,thumb:!1,width:0};UE.registerUI("myinsertimage",function(a,b){a.registerCommand(b,{execCommand:function(){require(["fileUploader"],function(b){b.show(function(b){if(0!=b.length)if(1==b.length)a.execCommand("insertimage",{src:b[0].url,_src:b[0].url,width:"100%",alt:b[0].filename});else{var c=[];for(i in b)c.push({src:b[i].url,_src:b[i].url,width:"100%",alt:b[i].filename});a.execCommand("insertimage",c)}},e)})}});var c=new UE.ui.Button({name:"插入图片",title:"插入图片",cssRules:"background-position: -726px -77px",onclick:function(){a.execCommand(b)}});return a.addListener("selectionchange",function(){var d=a.queryCommandState(b);-1==d?(c.setDisabled(!0),c.setChecked(!1)):(c.setDisabled(!1),c.setChecked(d))}),c},48),UE.registerUI("myinsertvideo",function(a,b){a.registerCommand(b,{execCommand:function(){require(["fileUploader"],function(b){b.show(function(b){if(b){var c=b.isRemote?"iframe":"video";a.execCommand("insertvideo",{url:b.url,width:300,height:200},c)}},{fileSizeLimit:512e4,type:"video",allowUploadVideo:!0})})}});var c=new UE.ui.Button({name:"插入视频",title:"插入视频",cssRules:"background-position: -320px -20px",onclick:function(){a.execCommand(b)}});return a.addListener("selectionchange",function(){var d=a.queryCommandState(b);-1==d?(c.setDisabled(!0),c.setChecked(!1)):(c.setDisabled(!1),c.setChecked(d))}),c},20),UE.registerUI("mylink",function(a,c){var d=new UE.ui.Button({name:"selectUrl",title:"系统链接",cssRules:"background-position: -622px 80px;",onclick:function(){b("#"+this.id).attr({"data-toggle":"selectUrl","data-callback":"selectUrlCallback"})}});return a.addListener("selectionchange",function(){var b=a.queryCommandState(c);-1==b?(d.setDisabled(!0),d.setChecked(!1)):(d.setDisabled(!1),d.setChecked(b))}),d}),"undefined"!=typeof UE&&UE.delEditor("rich");var f=UE.getEditor("rich",d);f.ready(function(){var a=c.data,d=a.rules;d=b.base64.decode(d),f.setContent(d),f.addListener("contentChange",function(){var a=f.getContent();a=b.base64.encode(a),b("#richtext").html(a).trigger("change")})})}b("#app-editor .js-selectStore").length>0&&(b(document).off("click",".js-selectStore"),b(document).on("click",".js-selectStore",function(){c.exchangeId=b(this).closest(".item").data("id"),irequire(["web/tiny"],function(a){a.selectStore(c.callbackStore,{mutil:0})})})),b("#app-editor .add-item").unbind("click").click(function(){var a=c.getId("M",0),d=c.length(c.data.redpackets),e=b(this).data("type");"exchanges"==e&&(a=c.getId("S",0),d=c.length(c.data.exchanges));var f=b(this).closest(".form-items").data("max");if(d>=f)return void Notify.info("最大添加 "+f+" 个！");"redpackets"==e?c.data.redpackets[a]={scene:"waimai",order_type_limit:0,name:"通用红包",discount:5,condition:0,grant_days_effect:0,use_days_limit:31,times:{},categorys:{}}:"exchanges"==e&&(c.data.exchanges[a]={store_id:0,logo:"../addons/we7_wmall/plugin/mealRedpacket/static/img/store-3.jpg",title:"门店名称",score:"5",activity:"满35减12;满60减20",discount:10,condition:0,grant_days_effect:0,use_days_limit:31}),c.tplmealRedpacket(),c.tplEditor()}),b("#app-editor .del-item").unbind("click").click(function(){var a=b(this).data("type"),d=b(this).closest(".form-items").data("min"),e=b(this).closest(".item").data("id"),f=c.length(c.data.redpackets);if("exchanges"==a&&(f=c.length(c.data.exchanges)),d&&f<=d)return void Notify.info("至少保留 "+d+" 个！");Notify.confirm("确定删除吗",function(){delete c.data[a][e],c.tplmealRedpacket(),c.tplEditor()})}),b("#app-editor .hour-add").unbind("click").click(function(){var a=b(this).closest(".item").data("id");c.data.redpackets[a].times||(c.data.redpackets[a].times={});var d=c.data.redpackets[a].times;if(c.length(d)>=3)return void Notify.info("最大添加3个！");d[c.getId("T",0)]={start_hour:"08:00",end_hour:"22:00"},c.tplEditor()}),b("#app-editor .hour-del").unbind("click").click(function(){var a=b(this).closest(".item").data("id"),d=b(this).data("id"),e=c.data.redpackets[a].times;Notify.confirm("确定删除吗",function(){delete e[d],c.tplEditor()})}),b("#app-editor .category-add").unbind("click").click(function(){var a=b(this).closest(".item").data("id");c.data.redpackets[a].categorys||(c.data.redpackets[a].categorys={});var d=c.data.redpackets[a].categorys,e=c.getId("C",0);d[e]={id:0,title:"选择分类",src:""},"paotui"==c.data.redpackets[a].scene&&(d[e].title="选择场景"),c.tplEditor()}),b("#app-editor .category-del").unbind("click").click(function(){var a=b(this).closest(".item").data("id"),d=c.data.redpackets[a].categorys,e=b(this).data("id");Notify.confirm("确定删除吗",function(){delete d[e],c.tplEditor()})}),b("#app-editor").find(".diy-bind").bind("input propertychange change",function(){var a=b(this),d=a.data("bind"),e=a.data("bind-child"),f=a.data("bind-parent"),g=a.data("bind-category"),h=a.data("bind-type"),i=a.data("bind-one"),j=a.data("bind-two"),k=a.data("bind-init"),l="",m=this.tagName;if("INPUT"==m){var n=a.data("placeholder");l=a.val(),l=""==l?n:l}else"SELECT"==m?l=a.find("option:selected").val():"TEXTAREA"==m&&(l=a.val());l=b.trim(l),e?f?g?h?i?j?c.data[e][f][d][g][h][i][j]=l:c.data[e][f][d][g][h][i]=l:c.data[e][f][d][g][h]=l:c.data[e][f][d][g]=l:c.data[e][f][d]=l:c.data[e][d]=l:c.data[d]=l,c.tplmealRedpacket(),k&&c.tplEditor()})},c.callbackStore=function(a){if(!a)return void Notify.error("回调数据错误，请重试！");var b=c.exchangeId;c.data.exchanges[b].store_id=a.id,c.data.exchanges[b].logo=a.logo,c.data.exchanges[b].title=a.title,c.data.exchanges[b].score=a.score,c.tplmealRedpacket(),c.tplEditor(),c.exchangeId=null},c.length=function(a){if(void 0===a)return 0;var b=0;for(var c in a)b++;return b},c.getId=function(a,b){return a+(+new Date+b)},c.initGotop=function(){b(window).bind("scroll resize",function(){b(window).scrollTop()>100?b("#gotop").show():b("#gotop").hide(),b("#gotop").unbind("click").click(function(){b("body").animate({scrollTop:"0px"},1e3)})})},c.save=function(){b(".btn-save").unbind("click").click(function(){var a=b(this);return Notify.confirm("确定保存吗?",function(){if(a.data("status"))return void Notify.info("正在保存，请稍候。。。");b(".btn-save").data("status",1).text("保存中...");b.post("./index.php?c=site&a=entry&ctrl=mealRedpacket&ac=meal&op=post&do=web&m=we7_wmall",{id:c.id,data:c.data},function(a){if(b(".btn-save").text("已保存").data("status",0),0!=a.message.errno)return void Notify.error(a.message.message);Notify.success("保存成功！",a.message.url)},"json")}),!1})},c});